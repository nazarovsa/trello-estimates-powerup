<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script>
    // Load CSS with fallback
    (function() {
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://p.trellocdn.com/power-up.min.css';

      var loaded = false;
      var timeout;

      link.onerror = function() {
        if (!loaded) {
          loaded = true;
          clearTimeout(timeout);
          var fallback = document.createElement('link');
          fallback.rel = 'stylesheet';
          fallback.href = './power-up.min.css';
          document.head.appendChild(fallback);
        }
      };

      timeout = setTimeout(function() {
        if (!loaded) {
          loaded = true;
          var fallback = document.createElement('link');
          fallback.rel = 'stylesheet';
          fallback.href = './power-up.min.css';
          document.head.appendChild(fallback);
        }
      }, 2000);

      document.head.appendChild(link);
    })();
  </script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 16px;
      margin: 0;
    }
    .total-display {
      text-align: center;
      color: #172b4d;
    }
    .total-number {
      font-size: 32px;
      font-weight: bold;
      color: #0079bf;
      margin: 8px 0;
    }
    .total-label {
      font-size: 14px;
      color: #5e6c84;
    }
  </style>
</head>
<body>
  <div class="total-display">
    <div class="total-label">Total Estimate</div>
    <div id="total" class="total-number">Loading...</div>
  </div>

  <script>
    // Load Trello library with fallback
    (function() {
      var script = document.createElement('script');
      script.src = 'https://p.trellocdn.com/power-up.min.js';
      script.onerror = function() {
        console.log('CDN failed, loading local library...');
        var fallback = document.createElement('script');
        fallback.src = './power-up.min.js';
        fallback.onload = initPopup;
        document.head.appendChild(fallback);
      };
      script.onload = initPopup;
      document.head.appendChild(script);
    })();

    function initPopup() {
      // Wait a bit for TrelloPowerUp to be fully initialized
      setTimeout(function() {
        if (typeof TrelloPowerUp === 'undefined') {
          console.error('TrelloPowerUp not loaded');
          document.getElementById('total').textContent = 'Error loading';
          return;
        }

        var t = TrelloPowerUp.iframe();
        var ESTIMATE_KEY = 'estimate';

        // Calculate total for this list
        t.cards('all')
          .then(function(cards) {
            var total = 0;
            var promises = cards.map(function(card) {
              return t.get(card.id, 'shared', ESTIMATE_KEY)
                .then(function(estimate) {
                  if (estimate && !isNaN(parseFloat(estimate))) {
                    total += parseFloat(estimate);
                  }
                });
            });
            
            return Promise.all(promises).then(function() {
              // Round to 2 decimal places
              total = Math.round(total * 100) / 100;
              document.getElementById('total').textContent = total;
            });
          })
          .catch(function(error) {
            document.getElementById('total').textContent = 'Error';
            console.error(error);
          });
      }, 100);
    }
  </script>
</body>
</html>
