<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script>
    // Load CSS with fallback
    (function() {
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://p.trellocdn.com/power-up.min.css';

      var loaded = false;
      var timeout;

      link.onerror = function() {
        if (!loaded) {
          loaded = true;
          clearTimeout(timeout);
          var fallback = document.createElement('link');
          fallback.rel = 'stylesheet';
          fallback.href = './power-up.min.css';
          document.head.appendChild(fallback);
        }
      };

      timeout = setTimeout(function() {
        if (!loaded) {
          loaded = true;
          var fallback = document.createElement('link');
          fallback.rel = 'stylesheet';
          fallback.href = './power-up.min.css';
          document.head.appendChild(fallback);
        }
      }, 2000);

      document.head.appendChild(link);
    })();
  </script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 12px;
      margin: 0;
    }
    .estimate-input {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 3px;
      box-sizing: border-box;
    }
    .estimate-input:focus {
      outline: none;
      border-color: #0079bf;
      box-shadow: 0 0 0 1px #0079bf;
    }
    .button-group {
      margin-top: 12px;
      display: flex;
      gap: 8px;
    }
    .btn {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    .btn-primary {
      background-color: #0079bf;
      color: white;
    }
    .btn-primary:hover {
      background-color: #026aa7;
    }
    .btn-secondary {
      background-color: #f4f5f7;
      color: #172b4d;
    }
    .btn-secondary:hover {
      background-color: #ebecf0;
    }
    .label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #172b4d;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <label class="label">Enter estimate (numeric value):</label>
  <input type="number" id="estimate" class="estimate-input" placeholder="e.g., 5, 8, 13" step="0.1">
  <div class="button-group">
    <button id="save" class="btn btn-primary">Save</button>
    <button id="clear" class="btn btn-secondary">Clear</button>
  </div>

  <script>
    // Load Trello library with fallback
    (function() {
      var script = document.createElement('script');
      script.src = 'https://p.trellocdn.com/power-up.min.js';
      script.onerror = function() {
        console.log('CDN failed, loading local library...');
        var fallback = document.createElement('script');
        fallback.src = './power-up.min.js';
        fallback.onload = initPopup;
        document.head.appendChild(fallback);
      };
      script.onload = initPopup;
      document.head.appendChild(script);
    })();

    function initPopup() {
      // Wait a bit for TrelloPowerUp to be fully initialized
      setTimeout(function() {
        if (typeof TrelloPowerUp === 'undefined') {
          console.error('TrelloPowerUp not loaded');
          return;
        }

        var t = TrelloPowerUp.iframe();
        var ESTIMATE_KEY = 'estimate';

        // Load current estimate
        t.get('card', 'shared', ESTIMATE_KEY)
          .then(function(estimate) {
            if (estimate) {
              document.getElementById('estimate').value = estimate;
            }
            // Set focus programmatically after loading
            try {
              document.getElementById('estimate').focus();
            } catch(e) {
              // Ignore focus errors in cross-origin frames
            }
          });

        // Save button handler
        document.getElementById('save').addEventListener('click', function() {
          var value = document.getElementById('estimate').value;
          
          if (value === '') {
            return t.alert({
              message: 'Please enter a numeric value',
              duration: 3
            });
          }

          if (isNaN(parseFloat(value))) {
            return t.alert({
              message: 'Please enter a valid number',
              duration: 3
            });
          }

          t.set('card', 'shared', ESTIMATE_KEY, value)
            .then(function() {
              t.closePopup();
            });
        });

        // Clear button handler
        document.getElementById('clear').addEventListener('click', function() {
          t.remove('card', 'shared', ESTIMATE_KEY)
            .then(function() {
              t.closePopup();
            });
        });

        // Allow Enter key to save
        document.getElementById('estimate').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            document.getElementById('save').click();
          }
        });
      }, 100);
    }
  </script>
</body>
</html>
